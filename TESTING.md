# Руководство по тестированию Est-Contact

## Подготовка к тестированию

### 1. Проверка окружения

Убедитесь, что все сервисы запущены:

```bash
# Проверка MySQL
docker ps | findstr est_contact

# Запуск Laravel
php artisan serve

# Открыть в браузере
start http://127.0.0.1:8000/admin
```

### 2. Вход в систему

**URL:** http://127.0.0.1:8000/admin/login

**Учетные данные:**
- Email: `admin@example.com`
- Пароль: `password`

## Тестовые сценарии

### Сценарий 1: Управление пользователями (Администратор)

1. **Создание нового пользователя:**
   - Перейдите в меню "Пользователи"
   - Нажмите "Создать"
   - Заполните:
     - Имя: "Иван Лидеров"
     - Email: "leader@example.com"
     - Пароль: "password"
     - Роль: Leader (должна быть выбрана по умолчанию)
     - Доступ в систему: Да
     - Email подтвержден: Да
   - Сохраните

2. **Создание менеджера:**
   - Создайте пользователя "Петр Менеджеров"
   - Email: "manager@example.com"
   - Роли: Manager + Leader
   - Доступ к Dashboard: Да
   - Доступ в систему: Да

3. **Проверка фильтров:**
   - Примените фильтр "Роль: Leader"
   - Должны отобразиться все созданные пользователи с ролью Leader

4. **Редактирование пользователя:**
   - Откройте созданного пользователя
   - Измените имя
   - Добавьте еще одну роль
   - Сохраните изменения

**Ожидаемый результат:** ✅
- Пользователи созданы
- Все действия залогированы в `activity_log` таблице
- Фильтры работают
- Изменения сохраняются

### Сценарий 2: Создание контактов (Менеджер)

1. **Выход и вход как менеджер:**
   - Выйдите из системы (иконка профиля → Выход)
   - Войдите как `manager@example.com` / `password`

2. **Создание первого контакта:**
   - Перейдите в "Контакты"
   - Нажмите "Создать"
   - Заполните:
     - ФИО: "Сидоров Сидор Сидорович"
     - Телефон: "+7 (999) 123-45-67"
     - Email: "sidorov@example.com"
     - Округ: "Центральный"
     - Статус: "Не обработан"
     - Ответственный лидер: НЕ назначать
   - Сохраните

3. **Создание второго контакта с назначением лидера:**
   - Создайте новый контакт:
     - ФИО: "Иванова Мария Петровна"
     - Телефон: "+7 (999) 111-22-33"
     - Email: "ivanova@example.com"
     - Округ: "Северный"
     - Статус: "Назначен исполнитель"
     - **Ответственный лидер:** "Иван Лидеров"
   - Сохраните

4. **Проверка email уведомления:**
   - Если настроен почтовый сервер (Mailtrap/MailHog), проверьте входящие
   - Должно прийти письмо на почту лидера о назначении контакта

**Ожидаемый результат:** ✅
- Контакты созданы
- Статус "Назначен исполнитель" установлен автоматически при выборе лидера
- Email отправлен (если настроен SMTP)
- История статусов записана в `contact_status_histories`

### Сценарий 3: Работа лидера с контактами

1. **Выход и вход как лидер:**
   - Выйдите из системы
   - Войдите как `leader@example.com` / `password`

2. **Просмотр "Моих контактов":**
   - Откройте "Контакты"
   - По умолчанию должен быть применен фильтр "Мои контакты"
   - Вы должны видеть только контакт "Иванова Мария Петровна"

3. **Просмотр всех контактов:**
   - Снимите галочку "Мои контакты" в фильтрах
   - Теперь видны ВСЕ контакты

4. **Добавление комментария:**
   - Откройте контакт "Иванова Мария Петровна"
   - Нажмите "Редактировать"
   - Прокрутите до секции "Комментарии"
   - Нажмите "Добавить комментарий"
   - Введите текст: "Связался с клиентом, ожидаю звонка завтра"
   - Сохраните

5. **Изменение статуса:**
   - Откройте тот же контакт на редактирование
   - Измените статус на "Обработан успешно"
   - Сохраните

6. **Проверка Badge:**
   - В левом меню рядом с "Контакты" должен отображаться badge
   - Он показывает количество ВАШИХ контактов без финальных статусов
   - После изменения статуса на "Обработан успешно" badge должен уменьшиться

**Ожидаемый результат:** ✅
- Лидер видит только свои контакты по умолчанию
- Может снять фильтр и видеть все
- НЕ может редактировать данные контакта (ФИО, телефон и т.д.)
- МОЖЕТ изменять статус
- МОЖЕТ добавлять комментарии
- НЕ может удалять комментарии
- История статусов обновляется
- Badge работает корректно

### Сценарий 4: Системные настройки (Суперадмин)

1. **Вход как admin:**
   - Войдите как `admin@example.com` / `password`

2. **Просмотр настроек:**
   - Перейдите в "Настройки"
   - Должна быть настройка `contact_processing_timeout_days` со значением `30`

3. **Изменение таймаута:**
   - Откройте настройку на редактирование
   - Измените значение на `15` (дней)
   - Сохраните

4. **Проверка описания:**
   - Убедитесь, что отображается описание настройки

**Ожидаемый результат:** ✅
- Настройки отображаются
- Значения можно изменять
- Кэш автоматически очищается при изменении

### Сценарий 5: Проверка просроченных контактов

1. **Подготовка тестовых данных:**
   - Войдите как менеджер
   - Создайте контакт со статусом "Назначен исполнитель"
   - В базе данных вручную измените `created_at` на 40 дней назад:
   ```sql
   UPDATE contacts 
   SET created_at = DATE_SUB(NOW(), INTERVAL 40 DAY)
   WHERE id = [ID контакта];
   ```

2. **Запуск команды проверки:**
   ```bash
   php artisan contacts:check-overdue
   ```

3. **Проверка результата:**
   - Контакт должен получить статус "Просрочен"
   - В `contact_status_histories` должна быть запись о смене статуса

**Ожидаемый результат:** ✅
- Команда отработала без ошибок
- Контакт со статусом "Назначен" старше 30 дней (или значения из настроек) получил статус "Просрочен"
- История обновлена

### Сценарий 6: Жизненный цикл контакта

1. **Полный цикл контакта (Менеджер + Лидер):**

**Менеджер:**
- Создает контакт (статус: "Не обработан")
- Назначает лидера (статус автоматически → "Назначен исполнитель")
- Лидер получает email

**Лидер:**
- Открывает "Мои контакты"
- Видит новый контакт
- Добавляет комментарий: "Связался, договорились о встрече"
- Изменяет статус на "Обработан успешно"

**Менеджер (опционально):**
- Видит контакт со статусом "Обработан успешно"
- При необходимости может вернуть статус обратно на "Не обработан" или "Назначен"

2. **Проверка истории:**
   - Откройте контакт на просмотр
   - В секции "История статусов" должны быть все изменения:
     - Создание (null → Не обработан)
     - Назначение (Не обработан → Назначен исполнитель)
     - Завершение (Назначен исполнитель → Обработан успешно)

**Ожидаемый результат:** ✅
- Все статусы корректно сменяются
- История записывается
- Комментарии сохраняются
- Email отправляются

### Сценарий 7: Поиск и фильтрация

1. **Поиск контактов:**
   - Войдите как admin
   - Откройте "Контакты"
   - В поиске введите номер телефона
   - Должен найтись соответствующий контакт

2. **Фильтрация по статусу:**
   - Примените фильтр "Статус: Назначен исполнитель"
   - Должны отобразиться только контакты с этим статусом

3. **Фильтрация по округу:**
   - Примените фильтр "Округ: Центральный"
   - Должны отобразиться контакты из этого округа

4. **Комбинированная фильтрация:**
   - Примените несколько фильтров одновременно
   - Результаты должны соответствовать всем критериям

**Ожидаемый результат:** ✅
- Поиск работает
- Фильтры применяются
- Можно комбинировать фильтры

### Сценарий 8: Регистрация нового пользователя

1. **Выход из системы:**
   - Нажмите "Выход"

2. **Регистрация:**
   - На странице входа нажмите ссылку "Зарегистрироваться"
   - Заполните форму:
     - Имя: "Новый Пользователь"
     - Email: "newuser@example.com"
     - Пароль: "password"
   - Отправьте форму

3. **Проверка статуса:**
   - Должна отобразиться страница с сообщением о необходимости подтверждения администратором
   - Пользователь НЕ должен войти в систему

4. **Подтверждение администратором:**
   - Войдите как admin
   - Откройте "Пользователи"
   - Найдите нового пользователя
   - Установите:
     - Email подтвержден: Да
     - Доступ в систему: Да
   - Сохраните

5. **Вход нового пользователя:**
   - Выйдите как admin
   - Войдите как `newuser@example.com` / `password`
   - Должен быть доступ к системе с ролью "Лидер"

**Ожидаемый результат:** ✅
- Регистрация работает
- Email верификация требуется
- Администратор должен одобрить
- По умолчанию роль "Лидер"

## Проверка базы данных

### Audit Log (Activity Log)

```sql
SELECT * FROM activity_log ORDER BY created_at DESC LIMIT 20;
```

Должны быть записи о всех действиях:
- created (создание контактов)
- updated (обновление контактов)
- deleted (удаление контактов)
- С указанием user_id, описанием и properties

### История статусов

```sql
SELECT 
    c.full_name,
    csh.old_status,
    csh.new_status,
    u.name as changed_by,
    csh.created_at
FROM contact_status_histories csh
JOIN contacts c ON c.id = csh.contact_id
JOIN users u ON u.id = csh.user_id
ORDER BY csh.created_at DESC;
```

### Комментарии

```sql
SELECT 
    c.full_name,
    u.name as author,
    cc.comment,
    cc.created_at
FROM contact_comments cc
JOIN contacts c ON c.id = cc.contact_id
JOIN users u ON u.id = cc.user_id
ORDER BY cc.created_at DESC;
```

## Тестирование производительности

### Создание тестовых данных

```bash
php artisan tinker
```

```php
// Создать 100 тестовых контактов
$manager = User::where('email', 'manager@example.com')->first();
$leader = User::where('email', 'leader@example.com')->first();

for ($i = 1; $i <= 100; $i++) {
    Contact::create([
        'full_name' => "Тестовый Контакт $i",
        'phone' => '+7 (999) ' . str_pad($i, 7, '0', STR_PAD_LEFT),
        'email' => "test$i@example.com",
        'district' => ['Центральный', 'Северный', 'Южный', 'Западный', 'Восточный'][rand(0, 4)],
        'status' => ['not_processed', 'assigned'][rand(0, 1)],
        'assigned_leader_id' => rand(0, 1) ? $leader->id : null,
        'created_by' => $manager->id,
    ]);
}
```

### Проверка пагинации

- Откройте список контактов
- Должна работать пагинация
- Попробуйте сортировку по разным колонкам
- Попробуйте поиск

## Checklist финального тестирования

- [ ] Все роли работают корректно
- [ ] CRUD операции выполняются
- [ ] Валидация полей работает
- [ ] Email уведомления отправляются (если настроен SMTP)
- [ ] История статусов записывается
- [ ] Комментарии добавляются
- [ ] Фильтры и поиск работают
- [ ] Audit log ведется
- [ ] Команда проверки просроченных контактов работает
- [ ] Регистрация требует подтверждения
- [ ] Локализация на русском языке
- [ ] Интерфейс адаптивный (проверить на мобильном)
- [ ] Нет критических ошибок в логах
- [ ] Производительность приемлема

## Известные ограничения

1. **Email:** Требует настройки SMTP для отправки уведомлений
2. **Scheduler:** Требует настройки cron для автоматической проверки просроченных контактов
3. **Queue:** Рекомендуется использовать queue worker для email уведомлений в production

## Отчет о проблемах

Если обнаружены проблемы, создайте issue с:
- Описанием проблемы
- Шагами для воспроизведения
- Ожидаемым и фактическим результатом
- Скриншотами (если применимо)
- Логами ошибок

---

**Статус тестирования:** ⏳ Готово к тестированию  
**Дата:** Февраль 2026  
**Версия:** 1.0.0
