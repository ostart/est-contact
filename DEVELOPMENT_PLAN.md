# План разработки приложения "Управление контактами"

## Технологический стек
- **Backend**: PHP 8.3
- **Framework**: Laravel 11.x (последняя совместимая версия)
- **Admin Panel**: Filament 3.x (последняя совместимая версия)
- **Database**: MySQL 5.7 (уже настроен в Docker)
- **Frontend**: Livewire 3.x (входит в Filament)
- **Локализация**: spatie/laravel-translatable или встроенные возможности Laravel

## Этап 1: Инициализация проекта

### 1.1 Установка Laravel и зависимостей
- [ ] Создать новый Laravel проект (версия 11.x)
- [ ] Установить Filament 3.x
- [ ] Настроить подключение к MySQL в `.env`
- [ ] Установить дополнительные пакеты:
  - `filament/spatie-laravel-translatable-plugin` - для мультиязычности
  - `spatie/laravel-permission` - для управления ролями и правами
  - `spatie/laravel-activitylog` - для аудита действий пользователей
  - `filament/notifications` - для уведомлений

### 1.2 Конфигурация окружения
- [ ] Настроить `.env` файл (подключение к БД, почтовый сервер)
- [ ] Настроить локализацию (ru, en)
- [ ] Настроить часовой пояс

## Этап 2: Проектирование базы данных

### 2.1 Миграции
- [ ] Расширить таблицу `users`:
  - email (уникальный, обязательный)
  - password (обязательный)
  - email_verified_at
  - is_approved (boolean, default false)
  - has_dashboard_access (boolean, default false)
  - created_at, updated_at

- [ ] Таблица `roles` (через spatie/laravel-permission):
  - id
  - name (leader, manager, administrator, superadmin)
  - guard_name
  
- [ ] Таблица `model_has_roles` (создается автоматически spatie)

- [ ] Таблица `contacts`:
  - id
  - full_name (обязательное)
  - phone (обязательное, с валидацией)
  - email (nullable, с валидацией)
  - district (округ)
  - status (enum: not_processed, assigned, overdue, success, failed)
  - assigned_leader_id (nullable, foreign key к users)
  - created_by (foreign key к users)
  - created_at, updated_at

- [ ] Таблица `contact_comments`:
  - id
  - contact_id (foreign key)
  - user_id (foreign key)
  - comment (text)
  - created_at, updated_at

- [ ] Таблица `contact_status_history`:
  - id
  - contact_id (foreign key)
  - user_id (foreign key)
  - old_status
  - new_status
  - created_at

- [ ] Таблица `system_settings`:
  - id
  - key (уникальный)
  - value
  - created_at, updated_at

- [ ] Таблица `activity_log` (создается автоматически spatie/laravel-activitylog)

### 2.2 Модели и связи
- [ ] Модель `User`:
  - Связь многие-ко-многим с ролями (через spatie)
  - Связь один-ко-многим с `Contact` (созданные контакты)
  - Связь один-ко-многим с `Contact` (назначенные контакты)
  
- [ ] Модель `Contact`:
  - Связь многие-к-одному с `User` (создатель)
  - Связь многие-к-одному с `User` (ответственный лидер)
  - Связь один-ко-многим с `ContactComment`
  - Связь один-ко-многим с `ContactStatusHistory`
  
- [ ] Модель `ContactComment`
- [ ] Модель `ContactStatusHistory`
- [ ] Модель `SystemSetting`

## Этап 3: Система аутентификации и авторизации

### 3.1 Регистрация и вход
- [ ] Создать кастомную страницу входа в Filament
- [ ] Создать страницу регистрации:
  - Форма с полями email и password
  - Валидация email при вводе
  - После регистрации - страница с уведомлением о необходимости подтверждения
  - Отправка email для подтверждения почты
  
- [ ] Реализовать подтверждение email
- [ ] Реализовать проверку is_approved при входе

### 3.2 Роли и права доступа
- [ ] Создать 4 роли: leader, manager, administrator, superadmin
- [ ] Настроить Policy для каждого ресурса
- [ ] Реализовать middleware для проверки ролей
- [ ] Настроить навигацию Filament на основе ролей:
  - Leader → Контакты
  - Manager → Управление
  - Administrator → Пользователи
  - Superadmin → Настройки
  - Dashboard → доступен по настройке

## Этап 4: Разработка функционала по ролям

### 4.1 Роль: Лидер (Leader)
- [ ] Создать Filament Resource `ContactResource` для лидеров:
  - Просмотр списка контактов
  - Фильтрация по: ФИО, телефон, округ, статус, исполнитель
  - Чекбокс "Мои контакты" (по умолчанию включен)
  - По умолчанию показывать только назначенные контакты без статуса success/failed
  - Просмотр деталей контакта
  - Изменение статуса контакта
  - Добавление комментариев (без возможности удаления)
  
- [ ] Реализовать валидацию прав доступа
- [ ] Настроить редирект на страницу контактов при входе

### 4.2 Роль: Менеджер (Manager)
- [ ] Создать Filament Resource `ContactManagementResource`:
  - CRUD операции для контактов
  - Поиск по: телефон, ФИО, округ
  - Назначение ответственного лидера
  - Валидация полей:
    - ФИО (обязательное)
    - Телефон (обязательное, формат телефона)
    - Email (валидация email)
  - Возможность перевода контакта из статуса "failed" в статус 1 или 2
  
- [ ] Отправка email-уведомления лидеру при назначении контакта

### 4.3 Роль: Администратор (Administrator)
- [ ] Создать Filament Resource `UserResource`:
  - Просмотр всех пользователей
  - Создание пользователя (роль leader включена по умолчанию)
  - Редактирование пользователя
  - Удаление пользователя
  - Блокировка пользователя (поле is_active)
  - Разрешение доступа в систему (поле is_approved)
  - Управление ролями пользователя (множественный выбор)
  - Предоставление доступа к дашборду (has_dashboard_access)

### 4.4 Роль: Суперадмин (Superadmin)
- [ ] Создать Filament Resource `SystemSettingsResource`:
  - Настройка таймаута просрочки обработки контакта (по умолчанию 30 дней)
  - Настройки почтового сервера:
    - MAIL_HOST
    - MAIL_PORT
    - MAIL_USERNAME
    - MAIL_PASSWORD
    - MAIL_ENCRYPTION
    - MAIL_FROM_ADDRESS
    - MAIL_FROM_NAME
  - Форма для редактирования настроек

### 4.5 Dashboard
- [ ] Создать кастомный Dashboard с виджетами статистики:
  - Общее количество контактов
  - Количество обработанных контактов
  - Количество контактов в работе
  - Количество новых контактов за последнюю неделю
  - Количество просроченных контактов
  - График динамики создания контактов
  - Диаграмма распределения по статусам
  
- [ ] Настроить доступ к Dashboard на основе has_dashboard_access

## Этап 5: Бизнес-логика

### 5.1 Жизненный цикл контакта
- [ ] Реализовать enum для статусов:
  1. not_processed (контакт не обработан)
  2. assigned (назначен исполнитель)
  3. overdue (просрочена обработка)
  4. success (обработан успешно - финальный)
  5. failed (обработан неуспешно - финальный, может быть переведен менеджером)

- [ ] Создать Observer для модели Contact:
  - При изменении статуса сохранять в `contact_status_history`
  - При назначении лидера отправлять email-уведомление

### 5.2 Автоматическая проверка просрочек
- [ ] Создать Command для проверки просроченных контактов:
  - Проверять контакты в статусе "assigned"
  - Сравнивать дату назначения с текущей датой и таймаутом
  - Переводить в статус "overdue" при превышении таймаута
  
- [ ] Зарегистрировать Command в Scheduler (запуск каждый день)

### 5.3 Аудит системы
- [ ] Настроить spatie/laravel-activitylog для логирования:
  - Создание/изменение/удаление контактов
  - Создание/изменение/удаление пользователей
  - Изменение настроек системы
  - Вход/выход пользователей
  - Изменение ролей пользователей

## Этап 6: Локализация

- [ ] Создать языковые файлы для русского и английского:
  - Перевод интерфейса Filament
  - Перевод полей моделей
  - Перевод сообщений валидации
  - Перевод email-уведомлений
  
- [ ] Настроить переключатель языка в Filament
- [ ] Установить русский язык как основной

## Этап 7: Email-уведомления

- [ ] Создать Notification для назначения контакта лидеру
- [ ] Создать Notification для подтверждения email при регистрации
- [ ] Настроить шаблоны писем (используя Markdown Mailable)
- [ ] Настроить очереди для отправки email (опционально)

## Этап 8: Адаптивность и UX

- [ ] Проверить адаптивность на мобильных устройствах
- [ ] Настроить темы Filament для лучшего отображения на мобильных
- [ ] Оптимизировать таблицы для мобильных экранов
- [ ] Добавить breadcrumbs для навигации
- [ ] Настроить уведомления (успех/ошибка) для всех операций

## Этап 9: Начальное заполнение данных

### 9.1 Seeders
- [ ] Создать RoleSeeder:
  - Создать 4 роли: leader, manager, administrator, superadmin

- [ ] Создать AdminUserSeeder:
  - Создать пользователя admin@example.com
  - Назначить все роли
  - Установить email_verified_at
  - Установить is_approved = true
  - Установить has_dashboard_access = true

- [ ] Создать SystemSettingsSeeder:
  - Установить contact_processing_timeout_days = 30

- [ ] Зарегистрировать все seeders в DatabaseSeeder

## Этап 10: Тестирование

- [ ] Функциональное тестирование:
  - Регистрация и вход пользователей
  - CRUD операции для всех ролей
  - Проверка прав доступа
  - Жизненный цикл контакта
  - Email-уведомления
  - Dashboard статистика
  
- [ ] Тестирование на разных устройствах и браузерах
- [ ] Тестирование локализации
- [ ] Проверка аудита (логи)

## Этап 11: Оптимизация и финализация

- [ ] Оптимизация запросов (N+1 проблемы)
- [ ] Добавление индексов в базу данных
- [ ] Кэширование (если необходимо)
- [ ] Проверка безопасности (SQL injection, XSS, CSRF)
- [ ] Документирование кода
- [ ] Финальное тестирование всех функций

## Этап 12: Развертывание

- [ ] Проверить все миграции
- [ ] Выполнить seeders
- [ ] Проверить настройки почтового сервера
- [ ] Настроить cron для Scheduler
- [ ] Создать документацию по развертыванию
- [ ] Создать руководство пользователя

## Технические детали реализации

### Версии пакетов (на февраль 2026)
```json
{
  "php": "^8.3",
  "laravel/framework": "^11.0",
  "filament/filament": "^3.2",
  "filament/spatie-laravel-translatable-plugin": "^3.2",
  "spatie/laravel-permission": "^6.0",
  "spatie/laravel-activitylog": "^4.8",
  "livewire/livewire": "^3.4"
}
```

### Структура проекта
```
est-contact/
├── app/
│   ├── Filament/
│   │   ├── Resources/
│   │   │   ├── ContactResource.php (для Leader)
│   │   │   ├── ContactManagementResource.php (для Manager)
│   │   │   ├── UserResource.php (для Administrator)
│   │   │   └── SystemSettingResource.php (для Superadmin)
│   │   ├── Pages/
│   │   │   └── Dashboard.php
│   │   └── Widgets/
│   │       ├── ContactsOverview.php
│   │       └── ContactsChart.php
│   ├── Models/
│   │   ├── User.php
│   │   ├── Contact.php
│   │   ├── ContactComment.php
│   │   ├── ContactStatusHistory.php
│   │   └── SystemSetting.php
│   ├── Observers/
│   │   └── ContactObserver.php
│   ├── Notifications/
│   │   ├── ContactAssignedNotification.php
│   │   └── EmailVerificationNotification.php
│   ├── Console/
│   │   └── Commands/
│   │       └── CheckOverdueContacts.php
│   └── Enums/
│       └── ContactStatus.php
├── database/
│   ├── migrations/
│   └── seeders/
├── resources/
│   └── lang/
│       ├── ru/
│       └── en/
└── docker-compose.yml
```

## Порядок выполнения

1. **Этапы 1-2**: Инициализация и база данных (1-2 дня)
2. **Этап 3**: Аутентификация и авторизация (2-3 дня)
3. **Этап 4**: Функционал по ролям (5-7 дней)
4. **Этап 5**: Бизнес-логика (2-3 дня)
5. **Этапы 6-7**: Локализация и уведомления (2 дня)
6. **Этап 8**: Адаптивность (1-2 дня)
7. **Этап 9**: Seeders (1 день)
8. **Этапы 10-11**: Тестирование и оптимизация (3-4 дня)
9. **Этап 12**: Развертывание и документация (1 день)

**Общая оценка**: 18-25 рабочих дней

## Важные замечания

1. Filament 3.x полностью совместим с PHP 8.3 и Laravel 11
2. MySQL 5.7 поддерживается Laravel 11 (требуется минимум MySQL 5.7.8)
3. Для мобильной адаптивности Filament 3 использует Tailwind CSS и уже оптимизирован для мобильных устройств
4. Для локализации используется встроенный механизм Laravel и плагин Filament
5. Аудит реализуется через spatie/laravel-activitylog - автоматическое логирование всех действий
